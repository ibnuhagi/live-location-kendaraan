<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Tracking System</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: #f8fafc; color: #1e293b; }
        
        #map { height: 50vh; width: 100%; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        .status-bar { 
            background: white; padding: 15px 25px; display: flex; 
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .badge {
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;
            text-transform: uppercase;
        }
        .bg-on { background: #dcfce7; color: var(--success); }
        .bg-off { background: #fee2e2; color: var(--danger); }

        .container { padding: 20px; max-width: 1100px; margin: auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); overflow: hidden; }
        
        .card-header { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; background: #fff; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px 20px; text-align: left; font-size: 13px; color: #64748b; }
        td { padding: 14px 20px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        
        .text-kill { color: var(--danger); font-weight: bold; font-size: 11px; border: 1px solid var(--danger); padding: 2px 5px; border-radius: 4px; }
        .btn-maps { color: var(--primary); text-decoration: none; font-weight: 600; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div>
            <h2 style="margin:0; font-size: 18px;"><i class="fa-solid fa-microchip"></i> Unit-01 Tracker</h2>
            <small id="last-sync">Menghubungkan...</small>
        </div>
        <div id="engine-badge" class="badge">Checking...</div>
    </div>

    <div id="map"></div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h3 style="margin:0"><i class="fa-solid fa-clock-rotate-left"></i> Histori Perjalanan</h3>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Koordinat (Lat, Lon)</th>
                            <th>Keterangan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD7r9PPgT88zbTqNfW1no-DY_c9CApSBGo",
            databaseURL: "https://monitoring-kendaraan-iot-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "monitoring-kendaraan-iot",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Setup Map dengan icon mobil kekinian
        var map = L.map('map').setView([-6.2088, 106.8456], 15);
        L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        
        var carIcon = L.divIcon({
            html: '<i class="fa-solid fa-car-side" style="color:#2563eb; font-size:24px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);"></i>',
            className: 'custom-div-icon',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        var marker = L.marker([-6.2088, 106.8456], {icon: carIcon}).addTo(map);

        // Update Live Location & Engine Status
        db.ref('monitoring_kendaraan/live_location').on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                const pos = [data.latitude, data.longitude];
                marker.setLatLng(pos);
                map.panTo(pos);
                
                // Update UI Status
                document.getElementById('last-sync').innerText = "Update: " + data.timestamp;
                const badge = document.getElementById('engine-badge');
                badge.innerText = "Engine: " + data.status_mesin;
                badge.className = "badge " + (data.status_mesin === "ON" ? "bg-on" : "bg-off");
            }
        });

        // Update Tabel Histori & Auto-Clear jika dihapus
        const historyRef = db.ref('monitoring_kendaraan/history');
        
        historyRef.on('value', (snapshot) => {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ""; // Bersihkan tabel setiap ada perubahan (termasuk hapus)
            
            const dataObj = snapshot.val();
            if (dataObj) {
                // Ubah object ke array dan urutkan terbaru di atas
                const keys = Object.keys(dataObj).reverse().slice(0, 20);
                keys.forEach(key => {
                    const item = dataObj[key];
                    const infoTag = item.info === "ENGINE KILL" ? `<span class="text-kill">ENGINE KILL</span>` : "-";
                    
                    const row = `
                        <tr>
                            <td>${item.timestamp}</td>
                            <td>${item.latitude.toFixed(5)}, ${item.longitude.toFixed(5)}</td>
                            <td>${infoTag}</td>
                            <td><a href="https://www.google.com/maps?q=${item.latitude},${item.longitude}" target="_blank" class="btn-maps"><i class="fa-solid fa-location-dot"></i> Maps</a></td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
        });
    </script>
</body>
</html>
