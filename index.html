<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracker Fix</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f8f9fa; }
        .header { background: white; padding: 15px; display: flex; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #map { height: 40vh; width: 100%; border-bottom: 2px solid #007bff; }
        .card { background: white; margin: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .badge-red { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header"><b>üõ∞Ô∏è GPS Tracker</b> <span id="statusEng">Mesin: --</span></div>
    <div id="map"></div>
    <div class="card">
        <h4>Riwayat Perjalanan <small id="coords" style="color:#888; float:right"></small></h4>
        <table>
            <thead><tr><th>Waktu</th><th>Lokasi</th><th>Aksi</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
    <script>
        const config = { apiKey: "AIzaSyD7r9PPgT88zbTqNfW1no-DY_c9CApSBGo", databaseURL: "https://monitoring-kendaraan-iot-default-rtdb.asia-southeast1.firebasedatabase.app" };
        firebase.initializeApp(config);
        const db = firebase.database();
        var map = L.map('map').setView([0,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var marker = L.marker([0,0]).addTo(map);

        db.ref('monitoring_kendaraan/live_location').on('value', (s) => {
            const d = s.val(); if(!d) return;
            const p = [d.latitude, d.longitude];
            marker.setLatLng(p); map.panTo(p); if(map.getZoom()<10) map.setZoom(15);
            document.getElementById('coords').innerText = d.latitude.toFixed(5) + "," + d.longitude.toFixed(5);
        });

        db.ref('monitoring_kendaraan/engine/status').on('value', (s) => {
            document.getElementById('statusEng').innerText = "Mesin: " + (s.val() || "ON");
        });

        db.ref('monitoring_kendaraan/history').limitToLast(10).on('value', (s) => {
            const body = document.getElementById('tableBody'); body.innerHTML = "";
            let rows = [];
            s.forEach(child => {
                const v = child.val();
                const ket = v.keterangan === "Engine Kill" ? `<br><span class="badge-red">(${v.keterangan})</span>` : "";
                rows.push(`<tr><td>${v.timestamp}${ket}</td><td>${v.latitude.toFixed(4)},${v.longitude.toFixed(4)}</td><td><a href="${v.maps_link}" target="_blank">Buka</a></td></tr>`);
            });
            body.innerHTML = rows.reverse().join('');
        });
    </script>
</body>
</html>
