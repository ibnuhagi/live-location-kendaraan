<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOT Vehicle Tracking System - Enterprise</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #1a73e8;
            --danger: #ea4335;
            --success: #34a853;
            --dark: #202124;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background: #f8f9fa; color: var(--dark); }
        
        /* Dashboard Header & Status */
        #top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1001;
        }

        #engine-badge {
            padding: 10px 25px; border-radius: 50px; font-weight: bold;
            display: flex; align-items: center; gap: 10px; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .bg-on { background: var(--success); color: white; }
        .bg-off { background: var(--danger); color: white; }

        /* Map Section */
        #map { height: 450px; width: 100%; z-index: 1; border-bottom: 5px solid var(--primary); }

        /* Content Section */
        .container { padding: 30px; max-width: 1200px; margin: auto; }
        .card { 
            background: white; border-radius: 20px; padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 30px;
        }

        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f1f3f4; color: #5f6368; padding: 15px; text-align: left; font-size: 13px; text-transform: uppercase; }
        td { padding: 18px 15px; border-bottom: 1px solid #f1f3f4; font-size: 14px; }
        
        /* Marker Modern */
        .modern-marker {
            width: 25px; height: 25px; background: var(--primary);
            border: 4px solid white; border-radius: 50%;
            box-shadow: 0 0 20px rgba(26, 115, 232, 0.8);
            position: relative; animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(26, 115, 232, 0); }
            100% { box-shadow: 0 0 0 0 rgba(26, 115, 232, 0); }
        }

        .btn-action {
            padding: 8px 16px; border-radius: 8px; text-decoration: none;
            font-size: 12px; font-weight: bold; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .btn-maps { background: #e8f0fe; color: var(--primary); }
        .btn-maps:hover { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-satellite-dish" style="color: var(--primary); font-size: 24px;"></i>
            <h2 style="margin:0; font-size: 20px;">V-Track <span style="font-weight: 300;">Pro</span></h2>
        </div>
        <div id="engine-badge" class="bg-off">
            <i class="fas fa-power-off"></i> <span id="status-text">ENGINE OFF</span>
        </div>
    </div>

    <div id="map"></div>

    <div class="container">
        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3 style="margin:0;"><i class="fas fa-history" style="margin-right:10px;"></i> Riwayat Aktivitas</h3>
                <span id="data-count" style="font-size:12px; color: #888;">0 Records</span>
            </div>
            
            <div class="table-container">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Waktu & Tanggal</th>
                            <th>Informasi Lokasi</th>
                            <th>Koordinat</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD7r9PPgT88zbTqNfW1no-DY_c9CApSBGo",
            databaseURL: "https://monitoring-kendaraan-iot-default-rtdb.asia-southeast1.firebasedatabase.app",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Map Initialization
        var map = L.map('map', {zoomControl: false}).setView([-6.2088, 106.8456], 15);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var modernIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div class='modern-marker'></div>",
            iconSize: [30, 30], iconAnchor: [15, 15]
        });
        var marker = L.marker([-6.2088, 106.8456], {icon: modernIcon}).addTo(map).bindPopup("<b>Menunggu GPS...</b>");

        // Engine Status Monitoring
        db.ref('monitoring_kendaraan/engine/status').on('value', (snap) => {
            const val = snap.val() || "OFF";
            const badge = document.getElementById('engine-badge');
            const text = document.getElementById('status-text');
            text.innerText = "ENGINE " + val;
            badge.className = (val === "ON") ? "bg-on" : "bg-off";
        });

        // Alamat Parser
        async function fetchAddress(lat, lon) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const d = await res.json();
                return d.display_name.split(',').slice(0,4).join(',');
            } catch (e) { return "Alamat Tidak Terjangkau"; }
        }

        // Live Location Listener
        db.ref('monitoring_kendaraan/live_location').on('value', async (snap) => {
            const data = snap.val();
            if(data && data.latitude != 0) {
                const pos = [data.latitude, data.longitude];
                marker.setLatLng(pos);
                map.panTo(pos);
                const addr = await fetchAddress(data.latitude, data.longitude);
                marker.getPopup().setContent(`
                    <div style="padding:5px;">
                        <b style="color:var(--primary)">KENDARAAN AKTIF</b><br>
                        <small>${data.timestamp}</small><br>
                        <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">
                        <span style="font-size:11px;">${addr}</span>
                    </div>
                `).update();
            }
        });

        // History Records Listener
        let count = 0;
        db.ref('monitoring_kendaraan/history').limitToLast(15).on('child_added', async (snap) => {
            const d = snap.val();
            count++;
            document.getElementById('data-count').innerText = count + " Records";
            const addr = await fetchAddress(d.latitude, d.longitude);
            
            const row = `
                <tr>
                    <td><b>${d.timestamp.split(' ')[0]}</b><br><small>${d.timestamp.split(' ').slice(1).join(' ')}</small></td>
                    <td style="max-width:300px;">${addr}</td>
                    <td style="color:#666; font-family:monospace;">${d.latitude.toFixed(5)}, ${d.longitude.toFixed(5)}</td>
                    <td>
                        <a href="https://www.google.com/maps?q=${d.latitude},${d.longitude}" target="_blank" class="btn-action btn-maps">
                            <i class="fas fa-external-link-alt"></i> Buka Maps
                        </a>
                    </td>
                </tr>`;
            document.getElementById('tableBody').insertAdjacentHTML('afterbegin', row);
        });
    </script>
</body>
</html>
