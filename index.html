<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Monitoring Kendaraan - Fix v2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }
        #map { height: 75vh; width: 100%; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .container { padding: 10px; max-width: 900px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .status-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
        .info-item { background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #edf2f7; text-align: center; }
        .info-item label { display: block; font-size: 9px; color: #9ca3af; font-weight: bold; text-transform: uppercase; }
        .info-item span { font-size: 12px; color: #111827; font-weight: 600; }
        #engine-status { font-weight: bold; padding: 2px 8px; border-radius: 10px; }
        .status-on { background-color: #d1fae5; color: #065f46; }
        .status-off { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="status-box">
            <div class="info-item">
                <label>Mesin</label>
                <span id="engine-status">OFF</span>
            </div>
            <div class="info-item">
                <label>Waktu</label>
                <span id="time">Menunggu...</span>
            </div>
            <div class="info-item">
                <label>Koordinat</label>
                <span id="coords">Mencari...</span>
            </div>
        </div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD7r9PPgT88zbTqNfW1no-DY_c9CApSBGo",
        databaseURL: "https://monitoring-kendaraan-iot-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const map = L.map('map').setView([0, 0], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const motorIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448624.png', 
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });

    let marker = L.marker([0, 0], {icon: motorIcon}).addTo(map);
    let firstLoad = true;

    const liveRef = ref(database, 'monitoring_kendaraan/live_location');
    onValue(liveRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.latitude !== 0) {
            const lat = parseFloat(data.latitude);
            const lon = parseFloat(data.longitude);
            const newPos = [lat, lon];

            document.getElementById("coords").innerText = lat.toFixed(6) + ", " + lon.toFixed(6);
            document.getElementById("time").innerText = data.timestamp;

            marker.setLatLng(newPos);
            
            // Auto-Center Logic
            if (firstLoad) {
                map.setView(newPos, 17);
                firstLoad = false;
            } else {
                map.panTo(newPos, { animate: true, duration: 1.0 });
            }
        }
    });

    const engineRef = ref(database, 'monitoring_kendaraan/engine/status');
    onValue(engineRef, (snapshot) => {
        const status = snapshot.val();
        const el = document.getElementById("engine-status");
        if (status) {
            el.innerText = status;
            el.className = (status === "ON") ? "status-on" : "status-off";
        }
    });
</script>
</body>
</html>
